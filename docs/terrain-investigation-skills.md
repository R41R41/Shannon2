# 地形調査スキル

ボットに周囲の環境を把握させるための 2 つの新しいスキルを実装しました。

## 概要

### 設計思想

従来の「座標とブロック名のリスト」では、建築のような複雑なタスクに限界がありました。また、全ボクセルデータを送ると膨大なトークンを消費します。

そこで、**階層的アプローチ**を採用：

1. **スキル ①: `get-blocks-in-area`** - 指定範囲のブロック情報を効率的に取得
2. **スキル ②: `investigate-terrain`** - LLM がスキル ① を駆使して、コンテクストに応じた調査を実行

この設計により：

- ✅ 汎用性が高い（LLM が調査方法を決定）
- ✅ トークン効率が良い（必要な範囲だけ取得）
- ✅ 拡張性が高い（新しい調査パターンを追加しやすい）

---

## スキル ① : `get-blocks-in-area`

### 機能

指定した始点と終点の座標範囲内のブロック情報を取得します。

### パラメータ

| パラメータ       | 型      | 必須 | デフォルト | 説明                                  |
| ---------------- | ------- | ---- | ---------- | ------------------------------------- |
| `x1`, `y1`, `z1` | number  | ✅   | -          | 始点の座標                            |
| `x2`, `y2`, `z2` | number  | ✅   | -          | 終点の座標                            |
| `format`         | string  | ❌   | `"layers"` | 出力形式（`layers`, `stats`, `list`） |
| `includeAir`     | boolean | ❌   | `false`    | 空気ブロックを含めるか                |

### 出力形式

#### 1. `layers` - レイヤー形式（建築分析向き）

高さ（Y 座標）ごとに 2D 配列で表現。記号で圧縮されているためトークン効率が良い。

```json
{
  "format": "layers",
  "area": {
    "min": { "x": 100, "y": 64, "z": 200 },
    "max": { "x": 110, "y": 74, "z": 210 },
    "dimensions": { "width": 11, "height": 11, "length": 11 }
  },
  "legend": {
    ".": "air",
    "S": "stone",
    "G": "grass_block",
    "D": "dirt"
  },
  "layers": [
    {
      "y": 64,
      "data": "SSSSSSSSSSS\nSSSSSSSSSS\n..."
    },
    {
      "y": 65,
      "data": "GGGGGGGGGGG\nGGGGGGGGGGG\n..."
    }
  ]
}
```

**用途**: 建築物の構造分析、平坦度チェック、家の設計など

#### 2. `stats` - 統計形式（資源探索向き）

ブロックタイプごとのカウント。

```json
{
  "format": "stats",
  "totalBlocks": 1331,
  "airCount": 800,
  "solidCount": 531,
  "density": "40%",
  "blockTypes": [
    { "block": "stone", "count": 300 },
    { "block": "dirt", "count": 150 },
    { "block": "coal_ore", "count": 15 }
  ]
}
```

**用途**: 資源探索、材料調達、バイオーム分析

#### 3. `list` - リスト形式（詳細確認向き）

個別ブロックの座標リスト（最大 100 個）。

```json
{
  "format": "list",
  "count": 50,
  "blocks": [
    { "position": { "x": 100, "y": 64, "z": 200 }, "block": "stone" },
    { "position": { "x": 100, "y": 64, "z": 201 }, "block": "stone" }
  ]
}
```

**用途**: 特定ブロックの正確な座標が必要な場合

### 使用例

```typescript
// 建築サイトを調査（10x5x10の範囲）
await bot.instantSkills.getSkill("get-blocks-in-area").run(
  100,
  64,
  200, // 始点
  110,
  69,
  210, // 終点
  "layers", // レイヤー形式
  false // 空気は省略
);

// 地下の鉱石を調査
await bot.instantSkills.getSkill("get-blocks-in-area").run(
  95,
  10,
  195, // 始点
  105,
  20,
  205, // 終点
  "stats", // 統計形式
  false
);
```

### 制限事項

- 最大 10,000 ブロックまで（範囲が大きすぎるとエラー）
- 推奨範囲: 10x10x10 程度（データ量削減のため）

---

## スキル ② : `investigate-terrain`

### 機能

ユーザーが指定したコンテクスト（調査目的）に基づいて、LLM が自動的に`get-blocks-in-area`などのツールを駆使して地形を調査します。

### パラメータ

| パラメータ     | 型     | 必須 | デフォルト | 説明                         |
| -------------- | ------ | ---- | ---------- | ---------------------------- |
| `context`      | string | ✅   | -          | 調査の目的（自然言語）       |
| `searchRadius` | number | ❌   | `10`       | 調査範囲の半径（ブロック数） |

### 使用例

#### 例 1: 建築サイト分析

```typescript
await bot.instantSkills.getSkill("investigate-terrain").run(
  "家を建てるのに適した平地を探す。10x10の平坦なスペースが必要",
  15 // 半径15ブロック
);
```

**期待される動作**:

1. LLM が周囲の地面レベルを複数箇所スキャン
2. 平坦度を計算
3. 障害物の有無をチェック
4. 結果を日本語で報告

**出力例**:

```
調査結果: ボットから北に5ブロックの位置に10x10の平坦な土地があります。
地面レベルはY=65で、障害物はありません。建築に最適です。
```

#### 例 2: 資源探索

```typescript
await bot.instantSkills
  .getSkill("investigate-terrain")
  .run("近くに鉄鉱石や石炭鉱石があるか確認したい", 20);
```

**期待される動作**:

1. LLM が`find-blocks`で鉄鉱石・石炭鉱石を検索
2. 見つかった場合、`get-blocks-in-area`で周辺の鉱脈を調査
3. 鉱石の数と位置を報告

**出力例**:

```
調査結果:
- 石炭鉱石: 12個発見（最も近いのは(105, 50, 210)）
- 鉄鉱石: 5個発見（最も近いのは(108, 48, 215)）
```

#### 例 3: 建築物の構造分析

```typescript
await bot.instantSkills
  .getSkill("investigate-terrain")
  .run(
    "目の前の建物の構造を分析して。何階建てで、どんな材料が使われているか",
    10
  );
```

**期待される動作**:

1. LLM がボットの正面方向の範囲をスキャン
2. レイヤー形式でブロック配置を取得
3. 階数と使用材料を分析

**出力例**:

```
調査結果: この建物は3階建てです。
- 1階: 主に石とオークの木材（床面積: 約8x6ブロック）
- 2階: オークの木材と窓ガラス
- 3階: オークの木材と屋根用の階段ブロック
使用材料: oak_planks(120個), stone(80個), glass(24個), oak_stairs(40個)
```

### 内部動作

1. **ツールバインディング**: LLM に以下のツールへのアクセスを提供

   - `get_blocks_in_area`: ブロック情報取得
   - `get_bot_position`: ボット位置確認
   - `find_blocks`: 特定ブロックの検索

2. **対話ループ**: 最大 5 回のツール呼び出しを許可

   - LLM が調査に必要なツールを順次呼び出し
   - 各ツールの結果を次の判断に活用
   - 最終的に日本語で結果を要約

3. **範囲制限**: `searchRadius`で指定した範囲内のみ調査可能
   - データ量を抑制
   - 無関係な領域をスキャンしない

### システムプロンプトの工夫

LLM に以下を指示：

- 一度に取得する範囲は 10x10x10 程度に抑える
- 建築分析では`layers`形式、資源探索では`stats`形式を使う
- 最終回答は日本語で、具体的な数値を含める
- 空気ブロックは基本的に省略

---

## トークン効率の比較

### 従来の方法（全ボクセルリスト）

16x16x16 = 4,096 ブロックを送信

```json
{
  "0,0,0": {"name": "stone", "position": {"x": 100, "y": 64, "z": 200}},
  "0,0,1": {"name": "stone", "position": {"x": 100, "y": 64, "z": 201}},
  ...
}
```

→ **約 15,000-20,000 トークン**

### 新しい方法（layers 形式 + 空気省略）

10x10x10 の範囲、空気を省略

```json
{
  "legend": { "S": "stone", "D": "dirt" },
  "layers": [{ "y": 64, "data": "SSSSSSSSSS\nSSSSSSSSSS\n..." }]
}
```

→ **約 500-1,000 トークン** ✅

### トークン削減率

**約 90-95%削減** 🎉

---

## 実装のポイント

### 1. **階層的情報提供**

- まず要約（`stats`）→ 必要なら詳細（`layers`）→ さらに詳細（`list`）
- LLM が必要に応じて掘り下げ

### 2. **記号による圧縮**

- レイヤーデータは 1 ブロック=1 文字
- 凡例で対応を明示

### 3. **LLM の自律性**

- 調査方法をハードコードせず、LLM に判断させる
- 新しいタイプの調査も自動的に対応可能

### 4. **範囲制限**

- 10,000 ブロック上限でメモリ保護
- `searchRadius`で無駄なスキャンを防止

---

## 今後の拡張可能性

### 追加可能な機能

1. **3D 可視化ツール**: 調査結果を ShannonUIMod 側で 3D 表示
2. **キャッシング**: 一度調査した範囲を記憶
3. **差分検出**: 建築前後の変化を追跡
4. **パターン認識**: 「この形は家だ」などの構造認識

### 他のタスクへの応用

- **建築**: 設計図との照合、進捗確認
- **採掘**: 鉱脈の追跡、安全な採掘ルート
- **農業**: 農地の状態確認、収穫タイミング判定
- **戦闘**: 地形を利用した戦術立案

---

## まとめ

この 2 つのスキルにより：

✅ **汎用性**: どんな調査にも対応（LLM が判断）  
✅ **効率性**: トークン消費を 90%以上削減  
✅ **拡張性**: 新しい調査パターンを簡単に追加  
✅ **実用性**: 建築のような複雑なタスクにも対応

次は実際に Minecraft 内でテストして、調整していきましょう！
